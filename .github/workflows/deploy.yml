name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: nprocess
  REGION: us-central1

jobs:
  # ============================================================================
  # Deploy n.process API
  # ============================================================================
  deploy-nprocess-api:
    name: Deploy n.process API
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy n.process API to Cloud Run
        run: |
          gcloud run deploy nprocess-api \
            --source . \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 1Gi \
            --cpu 1 \
            --timeout 300 \
            --concurrency 80 \
            --min-instances 0 \
            --max-instances 10 \
            --set-env-vars "GCP_PROJECT_ID=${{ env.PROJECT_ID }}" \
            --set-env-vars "FIRESTORE_DATABASE=(default)" \
            --set-env-vars "VERTEX_AI_LOCATION=us-central1" \
            --set-env-vars "VERTEX_AI_MODEL=gemini-1.5-pro-002" \
            --quiet

      - name: Get service URL
        id: api-url
        run: |
          URL=$(gcloud run services describe nprocess-api \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… n.process API deployed: $URL"

    outputs:
      api_url: ${{ steps.api-url.outputs.url }}

  # ============================================================================
  # Deploy Admin Dashboard
  # ============================================================================
  deploy-dashboard:
    name: Deploy Admin Dashboard
    runs-on: ubuntu-latest
    needs: [deploy-nprocess-api]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Admin Dashboard to Cloud Run
        env:
          API_URL: ${{ needs.deploy-nprocess-api.outputs.api_url }}
        run: |
          cd admin-dashboard

          # Generate NextAuth secret if not set
          NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
          if [ -z "$NEXTAUTH_SECRET" ]; then
            NEXTAUTH_SECRET=$(openssl rand -base64 32)
          fi

          gcloud run deploy nprocess-admin-dashboard \
            --source . \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --timeout 60 \
            --concurrency 80 \
            --min-instances 0 \
            --max-instances 5 \
            --set-env-vars "NEXT_PUBLIC_API_URL=$API_URL" \
            --set-env-vars "NEXT_PUBLIC_ADMIN_API_URL=$API_URL" \
            --set-env-vars "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" \
            --quiet

      - name: Get service URL
        id: dashboard-url
        run: |
          URL=$(gcloud run services describe nprocess-admin-dashboard \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Admin Dashboard deployed: $URL"

      - name: Update NEXTAUTH_URL
        env:
          DASHBOARD_URL: ${{ steps.dashboard-url.outputs.url }}
        run: |
          gcloud run services update nprocess-admin-dashboard \
            --region ${{ env.REGION }} \
            --set-env-vars "NEXTAUTH_URL=$DASHBOARD_URL" \
            --quiet

    outputs:
      dashboard_url: ${{ steps.dashboard-url.outputs.url }}

  # ============================================================================
  # Deployment Summary
  # ============================================================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-nprocess-api, deploy-dashboard]
    if: always()

    steps:
      - name: Print Deployment Summary
        run: |
          echo "========================================="
          echo "ðŸš€ Deployment Complete!"
          echo "========================================="
          echo ""
          echo "ðŸ“Š Service URLs:"
          echo "  - n.process API: ${{ needs.deploy-nprocess-api.outputs.api_url }}"
          echo "  - Admin Dashboard: ${{ needs.deploy-dashboard.outputs.dashboard_url }}"
          echo ""
          echo "ðŸ§ª Test the services:"
          echo "  curl ${{ needs.deploy-nprocess-api.outputs.api_url }}/health"
          echo ""
          echo "ðŸŽ¯ Access the dashboard:"
          echo "  ${{ needs.deploy-dashboard.outputs.dashboard_url }}"
          echo ""
          echo "========================================="

      - name: Create deployment status comment
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## ðŸš€ Deployment Complete!\n\n### Service URLs:\n- **n.process API**: ${{ needs.deploy-nprocess-api.outputs.api_url }}\n- **Admin Dashboard**: ${{ needs.deploy-dashboard.outputs.dashboard_url }}\n\n### Quick Test:\n\`\`\`bash\ncurl ${{ needs.deploy-nprocess-api.outputs.api_url }}/health\n\`\`\``
            });
